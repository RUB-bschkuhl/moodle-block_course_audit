/**
* JavaScript for handling tour creation via button click.
*
* @module block_course_audit/tour_creator
* @copyright 2025 Bastian Schmidt-Kuhl <bastian.schmidt-kuhl@ruhr-uni-bochum.de>
* @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
*/
define("block_course_audit/tour_creator",["jquery","core/ajax","core/str","tool_usertours/events","core/templates"],(function($,Ajax,Str,userTourEventsModule,Templates){let speechBubble=null,miauContainer=null,bubbleContainer=null,miauWrapper=null,storedActionDetails={};const bindStartAudit=function(courseId){console.log("bindStartAudit",courseId),$(".audit-start-button").on("click",(function(e){e.preventDefault();const $button=$(this),originalText=$button.text();$button.prop("disabled",!0),Str.get_string("creatingtour","block_course_audit").then((function(loadingText){return $button.text(loadingText),Ajax.call([{methodname:"block_course_audit_create_tour",args:{courseid:courseId}}])[0]})).then((function(response){let tourData=response.tourdata;return tourData.tourDetails[0],response.actionDetailsMap&&(storedActionDetails=response.actionDetailsMap),response.status?(hideBubble(),require(["tool_usertours/usertours"],(function(usertours){usertours.init(tourData.tourDetails,tourData.filterNames)})),Str.get_string("toursuccess","block_course_audit")):Str.get_string("tourerror","block_course_audit")})).then((function(text){$button.text(text)})).catch((function(){$button.text(originalText),$button.prop("disabled",!1)}))}))},listenForTourEnd=function(courseId){const userTourEvents=userTourEventsModule.eventTypes;document.addEventListener(userTourEvents.tourEnded,(function(){startTourSummary(courseId)}))},listenForTourStart=function(){const userTourEvents=userTourEventsModule.eventTypes;document.addEventListener(userTourEvents.tourStarted,(function(){expandAllSections(),$(document).on("click",".course-audit-action-button",(function(event){event.preventDefault(),function(event){const currentButton=$(event.target),classList=event.target.classList,auditActionClass=Array.from(classList).find((className=>className.startsWith("audit-action-")));if(auditActionClass){const idParts=auditActionClass.split("-");if(3===idParts.length){const mapKey=idParts[2],actionDetails=Object.values(storedActionDetails).find((details=>details.mapkey===mapKey));if(actionDetails){const details=actionDetails,args={};details.params.split("&").forEach((param=>{const[key,value]=param.split("=");args[key]=value})),currentButton.off("click"),currentButton.addClass("disabled-button-visuals"),Ajax.call([{methodname:details.endpoint,args:args}])[0].then((function(response){console.log("response",response,response.status),response&&response.status&&(currentButton.html("&#10004; Done"),currentButton.removeClass("btn-primary"))}))}else currentButton.off("click"),currentButton.addClass("disabled-button-visuals")}}}(event)}))}))},listenForStepChange=function(){const userTourEvents=userTourEventsModule.eventTypes;document.addEventListener(userTourEvents.stepHide,(function(){console.log("stepHide")}))},startTourSummary=function(courseId){return Ajax.call([{methodname:"block_course_audit_get_summary",args:{courseid:courseId}}])[0].then((async function(response){if(response&&response.status&&response.data){let summaryContainer=$(speechBubble);const processedResultsPromises=response.data.map((async function(result){const ruleNameKey="rule_"+result.rulekey+"_name";let ruleNameDisplay="",parsedMessages=[];try{ruleNameDisplay=await Str.get_string(ruleNameKey,"block_course_audit")}catch(e){ruleNameDisplay=result.rulekey}try{parsedMessages=JSON.parse(result.messages),Array.isArray(parsedMessages)||(parsedMessages=[String(parsedMessages)]);const messagePromises=parsedMessages.map((async msg=>{const langKeyMatch=msg.match(/^\[\[(.*?)\]\]$/);if(langKeyMatch){const langKey=langKeyMatch[1];try{return await Str.get_string(langKey,"block_course_audit")}catch(e){return"Error: "+langKey}}return msg}));parsedMessages=await Promise.all(messagePromises)}catch(e){parsedMessages=[result.messages||"Error displaying message."]}return{...result,ruleNameDisplay:ruleNameDisplay,messages:parsedMessages,isTodo:"0"===result.status,isDone:"1"===result.status}})),processedResults=await Promise.all(processedResultsPromises),templateContext={results:processedResults,hasResults:processedResults.length>0,timecreated:new Date(1e3*response.timecreated).toLocaleDateString("de-DE",{year:"numeric",month:"2-digit",day:"2-digit"}),rulecount:processedResults.length,passedcount:processedResults.filter((result=>"1"===result.status)).length,failedcount:processedResults.filter((result=>"0"===result.status)).length};return Templates.render("block_course_audit/block/summary",templateContext).then((function(html,js){return summaryContainer.empty(),Templates.appendNodeContents(summaryContainer,html,js),bubbleContainer&&!$(bubbleContainer).is(":visible")&&(triggerTalkAnimation(),$(bubbleContainer).show()),initMinimizeButton(),initToggleDetails(),response})).catch((function(){return response}))}return response}))},expandAllSections=function(){document.querySelectorAll('[id^="collapsesections"]').forEach((section=>{if("false"===section.getAttribute("aria-expanded"))section.click();else{document.querySelectorAll('[id^="collapsesectionid"]').forEach((i=>{"false"===i.getAttribute("aria-expanded")&&i.click()}))}}))},initMinimizeButton=function(){$(bubbleContainer).find(".btn-minimize").on("click",(function(e){e.preventDefault(),e.stopPropagation(),hideBubble()}))},initToggleDetails=function(){document.querySelectorAll(".check-header").forEach((header=>{header.addEventListener("click",(function(){toggleRuleCheck(this)}))}))},toggleRuleCheck=function(header){header.parentElement.classList.toggle("expanded")},hideBubble=function(){bubbleContainer&&$(bubbleContainer).is(":visible")&&($(miauContainer).removeClass("miau-talk"),$(bubbleContainer).hide())},addMiauSprite=function(){setTimeout((function(){miauWrapper&&($(miauWrapper).css("opacity","1"),$(miauWrapper).removeClass("slide-in"))}),2e3),miauWrapper&&$("#start-course-audit").add(miauWrapper).click((function(){bubbleContainer&&!$(bubbleContainer).is(":visible")&&(triggerTalkAnimation(),$(bubbleContainer).show())}))},triggerTalkAnimation=function(){miauContainer&&($(miauContainer).removeClass("miau-talk"),$(miauContainer).addClass("miau-talk"),setTimeout((function(){$(miauContainer).removeClass("miau-talk")}),8e3))};return{init:function(courseId){miauWrapper=document.getElementById("miau-wrapper"),speechBubble=document.getElementById("miau-speech-bubble"),miauContainer=document.getElementById("miau-gif"),bubbleContainer=document.getElementById("bubble-container"),miauWrapper&&(addMiauSprite(),initMinimizeButton(),bindStartAudit(courseId),initToggleDetails(),listenForTourStart(),listenForStepChange(),listenForTourEnd(courseId))}}}));

//# sourceMappingURL=tour_creator.min.js.map