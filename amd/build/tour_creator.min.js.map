{"version":3,"file":"tour_creator.min.js","sources":["../src/tour_creator.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle. If not, see <http://www.gnu.org/licenses/>.\n/**\n* JavaScript for handling tour creation via button click.\n*\n* @module block_course_audit/tour_creator\n* @copyright 2024 Your Name <your.email@example.com>\n* @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n*/\n\ndefine(['jquery', 'core/ajax', 'core/str', 'tool_usertours/events', 'core/templates'],\n    function ($, Ajax, Str, userTourEventsModule, Templates) {\n\n        let speechBubble = null;\n        let miauContainer = null;\n        let bubbleContainer = null;\n        let miauWrapper = null;\n        let storedActionDetails = {};\n\n        const getElements = function () {\n            miauWrapper = document.getElementById('miau-wrapper');\n            speechBubble = document.getElementById('miau-speech-bubble');\n            miauContainer = document.getElementById('miau-gif');\n            bubbleContainer = document.getElementById('bubble-container');\n        };\n\n        /**\n        * Initialize the module.\n        *\n        * @param {int} courseId The course ID\n        */\n        const init = function (courseId) {\n            getElements();\n            if (!miauWrapper) {\n                return;\n            }\n\n            addMiauSprite();\n\n            initMinimizeButton();\n\n            bindStartAudit(courseId);\n\n            initToggleDetails();\n\n            listenForTourStart();\n            listenForStepChange();\n            listenForTourEnd(courseId);\n        };\n\n        const bindStartAudit = function (courseId) {\n            console.log(\"bindStartAudit\", courseId);\n            $('.audit-start-button').on('click', function (e) {\n                e.preventDefault();\n\n                const $button = $(this);\n                const originalText = $button.text();\n                $button.prop('disabled', true);\n                Str.get_string('creatingtour', 'block_course_audit').then(function (loadingText) {\n                    $button.text(loadingText);\n                    return Ajax.call([{\n                        methodname: 'block_course_audit_create_tour',\n                        args: {\n                            courseid: courseId\n                        }\n                    }])[0];\n                }).then(function (response) {\n                    let tourData = response.tourdata;\n                    //TODO tourData.tourDetails[0] might not exist when all checks ok\n                    if (tourData.tourDetails[0]) {\n                    } else {\n                        //TODO Handle course audit no results\n                    }\n                    //TODO check if there is a running tour and then get the actionDetailsMap,\n                    // else it doesnt work when tour is started in any other way than clicking the button\n                    // e.g. continuing after reload\n                    if (response.actionDetailsMap) {\n                        storedActionDetails = response.actionDetailsMap;\n                    }\n\n                    if (response.status) {\n                        hideBubble();\n                        require(['tool_usertours/usertours'], function (usertours) {\n                            usertours.init(tourData.tourDetails, tourData.filterNames);\n                        });\n                        return Str.get_string('toursuccess', 'block_course_audit');\n                    }\n                    return Str.get_string('tourerror', 'block_course_audit');\n                }).then(function (text) {\n                    $button.text(text);\n                }).catch(function () {\n                    $button.text(originalText);\n                    $button.prop('disabled', false);\n                });\n            });\n        };\n\n        const callAction = function (event) {\n            const currentButton = $(event.target);\n            const classList = event.target.classList;\n            const auditActionClass = Array.from(classList).find(className => className.startsWith('audit-action-'));\n            if (auditActionClass) {\n                const idParts = auditActionClass.split('-');\n                if (idParts.length === 3) {\n                    const mapKey = idParts[2];\n                    const actionDetails = Object.values(storedActionDetails).find(details => details.mapkey === mapKey);\n                    if (actionDetails) {\n                        const details = actionDetails;\n                        const args = {};\n                        const params = details.params.split('&');\n                        params.forEach(param => {\n                            const [key, value] = param.split('=');\n                            args[key] = value;\n                        });\n                        //TODO show loading state\n                        //TODO wenn action ok dann sollte summary das reflektieren\n                        currentButton.off('click');\n                        currentButton.addClass('disabled-button-visuals');\n\n                        Ajax.call([{\n                            methodname: details.endpoint,\n                            args: args\n                        }])[0].then(function (response) {\n                            console.log(\"response\", response, response.status);\n                            if (response && response.status) {\n                                currentButton.html('&#10004; Done');\n                                currentButton.removeClass('btn-primary');\n                            }\n                        });\n                    } else {\n                        currentButton.off('click');\n                        currentButton.addClass('disabled-button-visuals');\n                    }\n                }\n            }\n        };\n\n        const listenForTourEnd = function (courseId) {\n            const userTourEvents = userTourEventsModule.eventTypes;\n            document.addEventListener(userTourEvents.tourEnded, function () {\n                startTourSummary(courseId);\n            });\n        };\n\n        const listenForTourStart = function () {\n            const userTourEvents = userTourEventsModule.eventTypes;\n            //tourStart never fires?\n            document.addEventListener(userTourEvents.tourStarted, function () {\n                expandAllSections();\n                $(document).on('click', '.course-audit-action-button', function (event) {\n                    event.preventDefault();\n                    callAction(event);\n                });\n            });\n        };\n\n        const listenForStepChange = function () {\n            const userTourEvents = userTourEventsModule.eventTypes;\n            /*             document.addEventListener(userTourEvents.stepRendered, function () {\n                        }); */\n            document.addEventListener(userTourEvents.stepHide, function () {\n                console.log(\"stepHide\");\n                // TODO klick neben Tour Element cancelled Tour.\n                // Dieses Event hier wird gefeuert, danach wird der nächste Step nicht gerendered.\n                // event genauer betrachten wodurch es ausgelöst wird.\n                // Die Tour muss dann neu gestartet werde. Fix überlegen?\n            });\n        };\n\n        const startTourSummary = function (courseId) {\n            const promise = Ajax.call([{\n                methodname: 'block_course_audit_get_summary',\n                args: {\n                    courseid: courseId\n                }\n            }])[0];\n\n            return promise.then(async function (response) {\n                if (response && response.status && response.data) {\n                    let summaryContainer = $(speechBubble);\n\n                    const processedResultsPromises = response.data.map(async function (result) {\n                        const ruleNameKey = 'rule_' + result.rulekey + '_name';\n                        let ruleNameDisplay = '';\n                        let parsedMessages = [];\n\n                        try {\n                            ruleNameDisplay = await Str.get_string(ruleNameKey, 'block_course_audit');\n                        } catch (e) {\n                            ruleNameDisplay = result.rulekey;\n                        }\n\n                        try {\n                            parsedMessages = JSON.parse(result.messages);\n                            if (!Array.isArray(parsedMessages)) {\n                                parsedMessages = [String(parsedMessages)];\n                            }\n\n                            // Process messages to handle language strings\n                            const messagePromises = parsedMessages.map(async msg => {\n                                // Check if message is a language key pattern like [[key]]\n                                const langKeyMatch = msg.match(/^\\[\\[(.*?)\\]\\]$/);\n                                if (langKeyMatch) {\n                                    const langKey = langKeyMatch[1];\n                                    try {\n                                        let str = await Str.get_string(langKey, 'block_course_audit');\n                                        return str;\n                                    } catch (e) {\n                                        return 'Error: ' + langKey;\n                                    }\n                                }\n                                return msg;\n                            });\n                            parsedMessages = await Promise.all(messagePromises);\n                        } catch (e) {\n                            parsedMessages = [result.messages || 'Error displaying message.'];\n                        }\n\n                        return {\n                            ...result,\n                            ruleNameDisplay: ruleNameDisplay,\n                            messages: parsedMessages,\n                            isTodo: result.status === '0',\n                            isDone: result.status === '1',\n                        };\n                    });\n                    const processedResults = await Promise.all(processedResultsPromises);\n                    const templateContext = {\n                        results: processedResults,\n                        hasResults: processedResults.length > 0,\n                        timecreated: new Date(response.timecreated * 1000).toLocaleDateString('de-DE', {\n                            year: 'numeric',\n                            month: '2-digit',\n                            day: '2-digit'\n                        }),\n                        rulecount: processedResults.length,\n                        passedcount: processedResults.filter(result => result.status === '1').length,\n                        failedcount: processedResults.filter(result => result.status === '0').length,\n                    };\n\n                    return Templates.render('block_course_audit/block/summary', templateContext)\n                        .then(function (html, js) {\n                            summaryContainer.empty();\n                            Templates.appendNodeContents(summaryContainer, html, js);\n                            if (bubbleContainer && !$(bubbleContainer).is(\":visible\")) {\n                                triggerTalkAnimation();\n                                $(bubbleContainer).show();\n                            }\n                            initMinimizeButton();\n                            initToggleDetails();\n                            return response;\n                        })\n                        .catch(function () {\n                            return response;\n                        });\n                }\n\n                return response;\n            });\n        };\n        const expandAllSections = function () {\n            const allSections = document.querySelectorAll('[id^=\"collapsesections\"]');\n            allSections.forEach(section => {\n                //check if all closed\n                if (section.getAttribute('aria-expanded') === 'false') {\n                    section.click();\n                } else {\n                    const individualSections = document.querySelectorAll('[id^=\"collapsesectionid\"]');\n                    individualSections.forEach(i => {\n                        //check if some closed\n                        if (i.getAttribute('aria-expanded') === 'false') {\n                            i.click();\n                        }\n                    });\n                }\n            });\n        };\n        const initMinimizeButton = function () {\n            $(bubbleContainer).find('.btn-minimize').on('click', function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                hideBubble();\n            });\n        };\n        const initToggleDetails = function () {\n            const headers = document.querySelectorAll('.check-header');\n            headers.forEach(header => {\n                header.addEventListener('click', function () {\n                    toggleRuleCheck(this);\n                });\n            });\n        };\n        const toggleRuleCheck = function (header) {\n            const ruleCheck = header.parentElement;\n            ruleCheck.classList.toggle('expanded');\n        };\n        const hideBubble = function () {\n            if (bubbleContainer && $(bubbleContainer).is(\":visible\")) {\n                $(miauContainer).removeClass('miau-talk');\n                $(bubbleContainer).hide();\n            }\n        };\n        const addMiauSprite = function () {\n            setTimeout(function () {\n                if (miauWrapper) {\n                    $(miauWrapper).css('opacity', '1');\n                    $(miauWrapper).removeClass('slide-in');\n                }\n            }, 2000);\n            if (miauWrapper) {\n                $('#start-course-audit').add(miauWrapper).click(function () {\n                    if (bubbleContainer && !$(bubbleContainer).is(\":visible\")) {\n                        triggerTalkAnimation();\n                        $(bubbleContainer).show();\n                    }\n                });\n            }\n        };\n        const triggerTalkAnimation = function () {\n            if (miauContainer) {\n                $(miauContainer).removeClass('miau-talk');\n                $(miauContainer).addClass('miau-talk');\n                setTimeout(function () {\n                    $(miauContainer).removeClass('miau-talk');\n                }, 8000);\n            }\n        };\n\n        return {\n            init: init\n        };\n    });"],"names":["define","$","Ajax","Str","userTourEventsModule","Templates","speechBubble","miauContainer","bubbleContainer","miauWrapper","storedActionDetails","bindStartAudit","courseId","console","log","on","e","preventDefault","$button","this","originalText","text","prop","get_string","then","loadingText","call","methodname","args","courseid","response","tourData","tourdata","tourDetails","actionDetailsMap","status","hideBubble","require","usertours","init","filterNames","catch","listenForTourEnd","userTourEvents","eventTypes","document","addEventListener","tourEnded","startTourSummary","listenForTourStart","tourStarted","expandAllSections","event","currentButton","target","classList","auditActionClass","Array","from","find","className","startsWith","idParts","split","length","mapKey","actionDetails","Object","values","details","mapkey","params","forEach","param","key","value","off","addClass","endpoint","html","removeClass","callAction","listenForStepChange","stepHide","async","data","summaryContainer","processedResultsPromises","map","result","ruleNameKey","rulekey","ruleNameDisplay","parsedMessages","JSON","parse","messages","isArray","String","messagePromises","langKeyMatch","msg","match","langKey","Promise","all","isTodo","isDone","processedResults","templateContext","results","hasResults","timecreated","Date","toLocaleDateString","year","month","day","rulecount","passedcount","filter","failedcount","render","js","empty","appendNodeContents","is","triggerTalkAnimation","show","initMinimizeButton","initToggleDetails","querySelectorAll","section","getAttribute","click","i","stopPropagation","header","toggleRuleCheck","parentElement","toggle","hide","addMiauSprite","setTimeout","css","add","getElementById"],"mappings":";;;;;;;AAsBAA,yCAAO,CAAC,SAAU,YAAa,WAAY,wBAAyB,mBAChE,SAAUC,EAAGC,KAAMC,IAAKC,qBAAsBC,eAEtCC,aAAe,KACfC,cAAgB,KAChBC,gBAAkB,KAClBC,YAAc,KACdC,oBAAsB,SAiCpBC,eAAiB,SAAUC,UAC7BC,QAAQC,IAAI,iBAAkBF,UAC9BX,EAAE,uBAAuBc,GAAG,SAAS,SAAUC,GAC3CA,EAAEC,uBAEIC,QAAUjB,EAAEkB,MACZC,aAAeF,QAAQG,OAC7BH,QAAQI,KAAK,YAAY,GACzBnB,IAAIoB,WAAW,eAAgB,sBAAsBC,MAAK,SAAUC,oBAChEP,QAAQG,KAAKI,aACNvB,KAAKwB,KAAK,CAAC,CACdC,WAAY,iCACZC,KAAM,CACFC,SAAUjB,aAEd,MACLY,MAAK,SAAUM,cACVC,SAAWD,SAASE,gBAEpBD,SAASE,YAAY,GAOrBH,SAASI,mBACTxB,oBAAsBoB,SAASI,kBAG/BJ,SAASK,QACTC,aACAC,QAAQ,CAAC,6BAA6B,SAAUC,WAC5CA,UAAUC,KAAKR,SAASE,YAAaF,SAASS,gBAE3CrC,IAAIoB,WAAW,cAAe,uBAElCpB,IAAIoB,WAAW,YAAa,yBACpCC,MAAK,SAAUH,MACdH,QAAQG,KAAKA,SACdoB,OAAM,WACLvB,QAAQG,KAAKD,cACbF,QAAQI,KAAK,YAAY,UA6C/BoB,iBAAmB,SAAU9B,gBACzB+B,eAAiBvC,qBAAqBwC,WAC5CC,SAASC,iBAAiBH,eAAeI,WAAW,WAChDC,iBAAiBpC,cAInBqC,mBAAqB,iBACjBN,eAAiBvC,qBAAqBwC,WAE5CC,SAASC,iBAAiBH,eAAeO,aAAa,WAClDC,oBACAlD,EAAE4C,UAAU9B,GAAG,QAAS,+BAA+B,SAAUqC,OAC7DA,MAAMnC,iBArDC,SAAUmC,aACnBC,cAAgBpD,EAAEmD,MAAME,QACxBC,UAAYH,MAAME,OAAOC,UACzBC,iBAAmBC,MAAMC,KAAKH,WAAWI,MAAKC,WAAaA,UAAUC,WAAW,sBAClFL,iBAAkB,OACZM,QAAUN,iBAAiBO,MAAM,QAChB,IAAnBD,QAAQE,OAAc,OAChBC,OAASH,QAAQ,GACjBI,cAAgBC,OAAOC,OAAO1D,qBAAqBiD,MAAKU,SAAWA,QAAQC,SAAWL,YACxFC,cAAe,OACTG,QAAUH,cACVtC,KAAO,GACEyC,QAAQE,OAAOR,MAAM,KAC7BS,SAAQC,cACJC,IAAKC,OAASF,MAAMV,MAAM,KACjCnC,KAAK8C,KAAOC,SAIhBtB,cAAcuB,IAAI,SAClBvB,cAAcwB,SAAS,2BAEvB3E,KAAKwB,KAAK,CAAC,CACPC,WAAY0C,QAAQS,SACpBlD,KAAMA,QACN,GAAGJ,MAAK,SAAUM,UAClBjB,QAAQC,IAAI,WAAYgB,SAAUA,SAASK,QACvCL,UAAYA,SAASK,SACrBkB,cAAc0B,KAAK,iBACnB1B,cAAc2B,YAAY,wBAIlC3B,cAAcuB,IAAI,SAClBvB,cAAcwB,SAAS,6BAoB3BI,CAAW7B,cAKjB8B,oBAAsB,iBAClBvC,eAAiBvC,qBAAqBwC,WAG5CC,SAASC,iBAAiBH,eAAewC,UAAU,WAC/CtE,QAAQC,IAAI,gBAQdkC,iBAAmB,SAAUpC,iBACfV,KAAKwB,KAAK,CAAC,CACvBC,WAAY,iCACZC,KAAM,CACFC,SAAUjB,aAEd,GAEWY,MAAK4D,eAAgBtD,aAC5BA,UAAYA,SAASK,QAAUL,SAASuD,KAAM,KAC1CC,iBAAmBrF,EAAEK,oBAEnBiF,yBAA2BzD,SAASuD,KAAKG,KAAIJ,eAAgBK,cACzDC,YAAc,QAAUD,OAAOE,QAAU,YAC3CC,gBAAkB,GAClBC,eAAiB,OAGjBD,sBAAwBzF,IAAIoB,WAAWmE,YAAa,sBACtD,MAAO1E,GACL4E,gBAAkBH,OAAOE,YAIzBE,eAAiBC,KAAKC,MAAMN,OAAOO,UAC9BvC,MAAMwC,QAAQJ,kBACfA,eAAiB,CAACK,OAAOL,wBAIvBM,gBAAkBN,eAAeL,KAAIJ,MAAAA,YAEjCgB,aAAeC,IAAIC,MAAM,sBAC3BF,aAAc,OACRG,QAAUH,aAAa,oBAETjG,IAAIoB,WAAWgF,QAAS,sBAE1C,MAAOvF,SACE,UAAYuF,gBAGpBF,OAEXR,qBAAuBW,QAAQC,IAAIN,iBACrC,MAAOnF,GACL6E,eAAiB,CAACJ,OAAOO,UAAY,mCAGlC,IACAP,OACHG,gBAAiBA,gBACjBI,SAAUH,eACVa,OAA0B,MAAlBjB,OAAOtD,OACfwE,OAA0B,MAAlBlB,OAAOtD,WAGjByE,uBAAyBJ,QAAQC,IAAIlB,0BACrCsB,gBAAkB,CACpBC,QAASF,iBACTG,WAAYH,iBAAiB5C,OAAS,EACtCgD,YAAa,IAAIC,KAA4B,IAAvBnF,SAASkF,aAAoBE,mBAAmB,QAAS,CAC3EC,KAAM,UACNC,MAAO,UACPC,IAAK,YAETC,UAAWV,iBAAiB5C,OAC5BuD,YAAaX,iBAAiBY,QAAO/B,QAA4B,MAAlBA,OAAOtD,SAAgB6B,OACtEyD,YAAab,iBAAiBY,QAAO/B,QAA4B,MAAlBA,OAAOtD,SAAgB6B,eAGnE3D,UAAUqH,OAAO,mCAAoCb,iBACvDrF,MAAK,SAAUuD,KAAM4C,WAClBrC,iBAAiBsC,QACjBvH,UAAUwH,mBAAmBvC,iBAAkBP,KAAM4C,IACjDnH,kBAAoBP,EAAEO,iBAAiBsH,GAAG,cAC1CC,uBACA9H,EAAEO,iBAAiBwH,QAEvBC,qBACAC,oBACOpG,YAEVW,OAAM,kBACIX,mBAIZA,aAGTqB,kBAAoB,WACFN,SAASsF,iBAAiB,4BAClC3D,SAAQ4D,aAE8B,UAA1CA,QAAQC,aAAa,iBACrBD,QAAQE,YACL,CACwBzF,SAASsF,iBAAiB,6BAClC3D,SAAQ+D,IAEiB,UAApCA,EAAEF,aAAa,kBACfE,EAAED,gBAMhBL,mBAAqB,WACvBhI,EAAEO,iBAAiBmD,KAAK,iBAAiB5C,GAAG,SAAS,SAAUC,GAC3DA,EAAEC,iBACFD,EAAEwH,kBACFpG,iBAGF8F,kBAAoB,WACNrF,SAASsF,iBAAiB,iBAClC3D,SAAQiE,SACZA,OAAO3F,iBAAiB,SAAS,WAC7B4F,gBAAgBvH,aAItBuH,gBAAkB,SAAUD,QACZA,OAAOE,cACfpF,UAAUqF,OAAO,aAEzBxG,WAAa,WACX5B,iBAAmBP,EAAEO,iBAAiBsH,GAAG,cACzC7H,EAAEM,eAAeyE,YAAY,aAC7B/E,EAAEO,iBAAiBqI,SAGrBC,cAAgB,WAClBC,YAAW,WACHtI,cACAR,EAAEQ,aAAauI,IAAI,UAAW,KAC9B/I,EAAEQ,aAAauE,YAAY,eAEhC,KACCvE,aACAR,EAAE,uBAAuBgJ,IAAIxI,aAAa6H,OAAM,WACxC9H,kBAAoBP,EAAEO,iBAAiBsH,GAAG,cAC1CC,uBACA9H,EAAEO,iBAAiBwH,YAK7BD,qBAAuB,WACrBxH,gBACAN,EAAEM,eAAeyE,YAAY,aAC7B/E,EAAEM,eAAesE,SAAS,aAC1BkE,YAAW,WACP9I,EAAEM,eAAeyE,YAAY,eAC9B,aAIJ,CACHzC,KA1SS,SAAU3B,UAXnBH,YAAcoC,SAASqG,eAAe,gBACtC5I,aAAeuC,SAASqG,eAAe,sBACvC3I,cAAgBsC,SAASqG,eAAe,YACxC1I,gBAAkBqC,SAASqG,eAAe,oBAUrCzI,cAILqI,gBAEAb,qBAEAtH,eAAeC,UAEfsH,oBAEAjF,qBACAiC,sBACAxC,iBAAiB9B"}