{"version":3,"file":"tour_creator.min.js","sources":["../src/tour_creator.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle. If not, see <http://www.gnu.org/licenses/>.\n/**\n* JavaScript for handling tour creation via button click.\n*\n* @module block_course_audit/tour_creator\n* @copyright 2024 Your Name <your.email@example.com>\n* @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n*/\n\ndefine(['jquery', 'core/ajax', 'core/str', 'tool_usertours/events', 'core/templates'],\n    function ($, Ajax, Str, userTourEventsModule, Templates) {\n\n        let speechBubble = null;\n        let miauContainer = null;\n        let bubbleContainer = null;\n        let miauWrapper = null;\n\n        const getElements = function () {\n            miauWrapper = document.getElementById('miau-wrapper');\n            speechBubble = document.getElementById('miau-speech-bubble');\n            miauContainer = document.getElementById('miau-gif');\n            bubbleContainer = document.getElementById('bubble-container');\n\n            if (!miauWrapper || !speechBubble || !miauContainer || !bubbleContainer) {\n                console.error('Course Audit: Could not find one or more required elements. Ensure templates are loaded.');\n            }\n        };\n\n        /**\n        * Initialize the module.\n        *\n        * @param {int} courseId The course ID\n        */\n        const init = function (courseId) {\n            getElements();\n            if (!miauWrapper) {\n                return;\n            }\n\n            addMiauSprite();\n\n            $(bubbleContainer).find('.btn-minimize').on('click', function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                hideBubble();\n            });\n\n            $('#audit-start').on('click', function (e) {\n                e.preventDefault();\n\n                const $button = $(this);\n                const originalText = $button.text();\n                $button.prop('disabled', true);\n                Str.get_string('creatingtour', 'block_course_audit').then(function (loadingText) {\n                    $button.text(loadingText);\n                    return Ajax.call([{\n                        methodname: 'block_course_audit_create_tour',\n                        args: {\n                            courseid: courseId\n                        }\n                    }])[0];\n                }).then(function (response) {\n                    var tourData = response.tourdata;\n                    listenForTourStart();\n                    listenForStepChange();\n                    //TODO tourData.tourDetails[0] might not exist when all checks ok\n                    listenForTourEnd(tourData.tourDetails[0].tourId);\n                    if (!tourData || !response.status) {\n                        let errorMessage = response.message || 'Unknown error creating tour data.';\n                        throw new Error(errorMessage);\n                    }\n                    if (response.status) {\n                        hideBubble();\n                        require(['tool_usertours/usertours'], function (usertours) {\n                            usertours.init(tourData.tourDetails, tourData.filterNames);\n                        });\n                        return Str.get_string('toursuccess', 'block_course_audit');\n                    }\n                    return Str.get_string('tourerror', 'block_course_audit');\n                }).then(function (text) {\n                    $button.text(text);\n                }).catch(function (errors) {\n                    console.error(errors);\n                    $button.text(originalText);\n                    $button.prop('disabled', false);\n                });\n            });\n        };\n\n        const listenForTourEnd = function (tourId) {\n            const userTourEvents = userTourEventsModule.eventTypes;\n            document.addEventListener(userTourEvents.tourEnded, function () {\n                console.log(\"tourEnded\");\n                // $(miauWrapper).show(); // TODO doesnt show when tour is cancelled\n                startTourSummary(tourId);\n            });\n        };\n\n        const listenForTourStart = function () {\n            const userTourEvents = userTourEventsModule.eventTypes;\n            document.addEventListener(userTourEvents.tourStarted, function () {\n                // $(miauWrapper).hide();\n            });\n        };\n\n        const listenForStepChange = function () {\n            const userTourEvents = userTourEventsModule.eventTypes;\n            document.addEventListener(userTourEvents.stepRendered, function () {\n                const stepElement = document.querySelector('[id^=\"tour-step-tool_usertours\"]');\n                if (stepElement) {\n                    stepElement.scrollIntoView({behavior: 'smooth', block: 'center'});\n                } else {\n                    console.warn('Course Audit: Could not find tour step element to scroll:', stepElement);\n                }\n            });\n            document.addEventListener(userTourEvents.stepHide, function () {\n                //TODO klick neben Tour Element cancelled Tour. \n                // Dieses Event hier wird gefeuert, danach wird der nächste Step nicht gerendered.\n                // Die Tour muss dann neu gestartet werde. Fix überlegen?\n                console.log(\"stepHide\");\n            });\n        };\n\n        const startTourSummary = function (tourId) {\n            const promise = Ajax.call([{\n                methodname: 'block_course_audit_get_summary',\n                args: {\n                    tourid: tourId\n                }\n            }])[0];\n\n            return promise.then(function (response) {\n                if (response && response.status && response.data) {\n                    let summaryContainer = $(speechBubble);\n\n                    const processedResults = response.data.map(function (result) {\n                        return {\n                            ...result,\n                            isPassed: result.status === 'pass',\n                            isFailed: result.status === 'fail'\n                        };\n                    });\n\n                    // Organize the data for the template\n                    const templateContext = {\n                        results: processedResults,\n                        tourId: tourId,\n                        hasResults: processedResults.length > 0,\n                        message: response.message,\n                        status: response.status\n                    };\n\n                    // Render the template and update the container\n                    return Templates.render('block_course_audit/block/summary', templateContext)\n                        .then(function (html, js) {\n                            summaryContainer.empty();\n                            Templates.appendNodeContents(summaryContainer, html, js);\n                            if (bubbleContainer && !$(bubbleContainer).is(\":visible\")) {\n                                triggerTalkAnimation();\n                                $(bubbleContainer).show();\n                            }\n                            return response;\n                        })\n                        .catch(function (error) {\n                            console.error('Error rendering template:', error);\n                            return response;\n                        });\n                }\n\n                return response;\n            }).catch(function (errors) {\n                console.error(errors);\n            });\n        };\n\n        const hideBubble = function () {\n            if (bubbleContainer && $(bubbleContainer).is(\":visible\")) {\n                $(miauContainer).removeClass('miau-talk');\n                $(bubbleContainer).hide();\n            }\n        };\n        const addMiauSprite = function () {\n            setTimeout(function () {\n                if (miauWrapper) {\n                    $(miauWrapper).css('opacity', '1');\n                    $(miauWrapper).removeClass('slide-in');\n                }\n            }, 2000);\n            if (miauWrapper) {\n                $('#start-course-audit').add(miauWrapper).click(function () {\n                    if (bubbleContainer && !$(bubbleContainer).is(\":visible\")) {\n                        triggerTalkAnimation();\n                        $(bubbleContainer).show();\n                    }\n                });\n            }\n        };\n        const triggerTalkAnimation = function () {\n            if (miauContainer) {\n                $(miauContainer).removeClass('miau-talk');\n                $(miauContainer).addClass('miau-talk');\n                setTimeout(function () {\n                    $(miauContainer).removeClass('miau-talk');\n                }, 8000);\n            }\n        };\n        return {\n            init: init\n        };\n    });"],"names":["define","$","Ajax","Str","userTourEventsModule","Templates","speechBubble","miauContainer","bubbleContainer","miauWrapper","listenForTourEnd","tourId","userTourEvents","eventTypes","document","addEventListener","tourEnded","console","log","startTourSummary","listenForTourStart","tourStarted","listenForStepChange","stepRendered","stepElement","querySelector","scrollIntoView","behavior","block","warn","stepHide","call","methodname","args","tourid","then","response","status","data","summaryContainer","processedResults","map","result","isPassed","isFailed","templateContext","results","hasResults","length","message","render","html","js","empty","appendNodeContents","is","triggerTalkAnimation","show","catch","error","errors","hideBubble","removeClass","hide","addMiauSprite","setTimeout","css","add","click","addClass","init","courseId","getElementById","find","on","e","preventDefault","stopPropagation","$button","this","originalText","text","prop","get_string","loadingText","courseid","tourData","tourdata","tourDetails","errorMessage","Error","require","usertours","filterNames"],"mappings":"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"}