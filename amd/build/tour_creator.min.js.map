{"version":3,"file":"tour_creator.min.js","sources":["../src/tour_creator.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle. If not, see <http://www.gnu.org/licenses/>.\n/**\n* JavaScript for handling tour creation via button click.\n*\n* @module block_course_audit/tour_creator\n* @copyright 2024 Your Name <your.email@example.com>\n* @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n*/\n\ndefine(['jquery', 'core/ajax', 'core/str', 'tool_usertours/events', 'core/templates'],\n    function ($, Ajax, Str, userTourEventsModule, Templates) {\n\n        let speechBubble = null;\n        let miauContainer = null;\n        let bubbleContainer = null;\n        let miauWrapper = null;\n        let storedActionDetails = {};\n\n        const getElements = function () {\n            miauWrapper = document.getElementById('miau-wrapper');\n            speechBubble = document.getElementById('miau-speech-bubble');\n            miauContainer = document.getElementById('miau-gif');\n            bubbleContainer = document.getElementById('bubble-container');\n\n            if (!miauWrapper || !speechBubble || !miauContainer || !bubbleContainer) {\n                console.error('Course Audit: Could not find one or more required elements. Ensure templates are loaded.');\n            }\n        };\n\n        /**\n        * Initialize the module.\n        *\n        * @param {int} courseId The course ID\n        */\n        const init = function (courseId) {\n            //TODO Prüfen ob Tour bereits existiert, wenn ja zeige nur Summary und Möglichkeit des neustarts\n            getElements();\n            if (!miauWrapper) {\n                return;\n            }\n\n            addMiauSprite();\n\n            $(bubbleContainer).find('.btn-minimize').on('click', function (e) {\n                e.preventDefault();\n                e.stopPropagation();\n                hideBubble();\n            });\n\n            $('#audit-start').on('click', function (e) {\n                e.preventDefault();\n\n                const $button = $(this);\n                const originalText = $button.text();\n                $button.prop('disabled', true);\n                Str.get_string('creatingtour', 'block_course_audit').then(function (loadingText) {\n                    $button.text(loadingText);\n                    return Ajax.call([{\n                        methodname: 'block_course_audit_create_tour',\n                        args: {\n                            courseid: courseId\n                        }\n                    }])[0];\n                }).then(function (response) {\n                    let tourData = response.tourdata;\n                    listenForTourStart();\n                    listenForStepChange();\n                    //TODO tourData.tourDetails[0] might not exist when all checks ok\n                    if (tourData.tourDetails[0]) {\n                        listenForTourEnd(tourData.tourDetails[0].tourId);\n                    } else {\n                        console.error('Course Audit: Could not find tour details in response');\n                        //TODO Handle course audit no results\n                    }\n\n                    if (!tourData || !response.status) {\n                        let errorMessage = response.message || 'Unknown error creating tour data.';\n                        throw new Error(errorMessage);\n                    }\n\n                    if (response.actionDetailsMap) {\n                        storedActionDetails = response.actionDetailsMap;\n                    }\n\n                    $(document).on('click', '.course-audit-action-button', function (event) {\n                        event.preventDefault();\n                        callAction(event);\n                    });\n\n                    if (response.status) {\n                        hideBubble();\n                        require(['tool_usertours/usertours'], function (usertours) {\n                            usertours.init(tourData.tourDetails, tourData.filterNames);\n                        });\n                        return Str.get_string('toursuccess', 'block_course_audit');\n                    }\n                    return Str.get_string('tourerror', 'block_course_audit');\n                }).then(function (text) {\n                    $button.text(text);\n                }).catch(function (errors) {\n                    console.error(errors);\n                    $button.text(originalText);\n                    $button.prop('disabled', false);\n                });\n            });\n        };\n\n        const callAction = function (event) {\n            const classList = event.target.classList;\n            const auditActionClass = Array.from(classList).find(className => className.startsWith('audit-action-'));\n            if (auditActionClass) {\n                const idParts = auditActionClass.split('-');\n                if (idParts.length === 4) {\n                    const sectionId = idParts[2];\n                    const ruleKey = idParts[3];\n                    const mapKey = `section_${sectionId}_${ruleKey}`;\n                    const actionDetails = Object.values(storedActionDetails).find(details => details.mapkey === mapKey);\n                    if (actionDetails) {\n                        const details = actionDetails;\n                        const args = {};\n                        const params = details.params.split('&');\n                        params.forEach(param => {\n                            const [key, value] = param.split('=');\n                            args[key] = value;\n                        });\n                        //TODO then console log response\n                        let response = Ajax.call([{\n                            methodname: details.endpoint,\n                            args: args\n                        }])[0];\n                        console.log('response', response);\n                        return response;\n                    } else {\n                        console.error('Action details not found for key:', mapKey);\n                    }\n                }\n            }\n        };\n\n        const listenForTourEnd = function (tourId) {\n            const userTourEvents = userTourEventsModule.eventTypes;\n            document.addEventListener(userTourEvents.tourEnded, function () {\n                // $(miauWrapper).show(); // TODO doesnt show when tour is cancelled\n                startTourSummary(tourId);\n            });\n        };\n\n        const listenForTourStart = function () {\n            const userTourEvents = userTourEventsModule.eventTypes;\n            document.addEventListener(userTourEvents.tourStarted, function () {\n                // TODO open all sections to display all tour steps correctly\n                // $(miauWrapper).hide();\n            });\n        };\n\n        const listenForStepChange = function () {\n            const userTourEvents = userTourEventsModule.eventTypes;\n            document.addEventListener(userTourEvents.stepRendered, function () {\n                /*   const stepElement = $('[id^=\"tour-step-tool_usertours\"]');\n                   $('[id^=\"tour-step-tool_usertours\"]').each(function() {\n                      if ($(this).is(':visible')) {\n                          console.log('stepElement', $(this));\n                      }\n                  });\n                  if (stepElement) {\n                      stepElement.scrollIntoView({ behavior: 'smooth', block: 'center' });\n                  } else {\n                      console.warn('Course Audit: Could not find tour step element to scroll:', stepElement);\n                  } */\n            });\n            document.addEventListener(userTourEvents.stepHide, function () {\n                // TODO klick neben Tour Element cancelled Tour.\n                // Dieses Event hier wird gefeuert, danach wird der nächste Step nicht gerendered.\n                // event genauer betrachten wodurch es ausgelöst wird.\n                // Die Tour muss dann neu gestartet werde. Fix überlegen?\n            });\n        };\n\n        const startTourSummary = function (tourId) {\n            const promise = Ajax.call([{\n                methodname: 'block_course_audit_get_summary',\n                args: {\n                    tourid: tourId\n                }\n            }])[0];\n\n            return promise.then(async function (response) {\n                if (response && response.status && response.data) {\n                    console.log('response', response);\n                    let summaryContainer = $(speechBubble);\n\n                    const processedResultsPromises = response.data.map(async function (result) {\n                        const ruleNameKey = 'rule_' + result.rulekey + '_name';\n                        let ruleNameDisplay = '';\n                        let parsedMessages = [];\n\n                        try {\n                            ruleNameDisplay = await Str.get_string(ruleNameKey, 'block_course_audit');\n                        } catch (e) {\n                            console.error('Error fetching string:', ruleNameKey, e);\n                            ruleNameDisplay = result.rulekey;\n                        }\n\n                        try {\n                            parsedMessages = JSON.parse(result.messages);\n                            if (!Array.isArray(parsedMessages)) {\n                                console.warn('Parsed messages is not an array for rule:', result.rulekey, parsedMessages);\n                                parsedMessages = [String(parsedMessages)];\n                            }\n\n                            // Process messages to handle language strings\n                            const messagePromises = parsedMessages.map(async msg => {\n                                // Check if message is a language key pattern like [[key]]\n                                const langKeyMatch = msg.match(/^\\[\\[(.*?)\\]\\]$/);\n                                if (langKeyMatch) {\n                                    const langKey = langKeyMatch[1];\n                                    try {\n                                        console.log(langKey);\n                                        let str = await Str.get_string(langKey, 'block_course_audit');\n                                        console.log(str);\n                                        return str;\n                                    } catch (e) {\n                                        console.error('Error fetching string for key:', langKey, e);\n                                        return 'Error: ' + langKey;\n                                    }\n                                }\n                                return msg;\n                            });\n                            parsedMessages = await Promise.all(messagePromises);\n                        } catch (e) {\n                            console.error('Error parsing messages JSON for rule:', result.rulekey, result.messages, e);\n                            parsedMessages = [result.messages || 'Error displaying message.'];\n                        }\n\n                        return {\n                            ...result,\n                            ruleNameDisplay: ruleNameDisplay,\n                            messages: parsedMessages,\n                            isTodo: result.status === '0',\n                            isDone: result.status === '1'\n                        };\n                    });\n                    const processedResults = await Promise.all(processedResultsPromises);\n\n                    const templateContext = {\n                        results: processedResults,\n                        hasResults: processedResults.length > 0,\n                    };\n\n                    return Templates.render('block_course_audit/block/summary', templateContext)\n                        .then(function (html, js) {\n                            summaryContainer.empty();\n                            Templates.appendNodeContents(summaryContainer, html, js);\n                            if (bubbleContainer && !$(bubbleContainer).is(\":visible\")) {\n                                triggerTalkAnimation();\n                                $(bubbleContainer).show();\n                            }\n                            return response;\n                        })\n                        .catch(function (error) {\n                            console.error('Error rendering template:', error);\n                            return response;\n                        });\n                }\n\n                return response;\n            }).catch(function (errors) {\n                console.error(errors);\n            });\n        };\n\n        const hideBubble = function () {\n            if (bubbleContainer && $(bubbleContainer).is(\":visible\")) {\n                $(miauContainer).removeClass('miau-talk');\n                $(bubbleContainer).hide();\n            }\n        };\n        const addMiauSprite = function () {\n            setTimeout(function () {\n                if (miauWrapper) {\n                    $(miauWrapper).css('opacity', '1');\n                    $(miauWrapper).removeClass('slide-in');\n                }\n            }, 2000);\n            if (miauWrapper) {\n                $('#start-course-audit').add(miauWrapper).click(function () {\n                    if (bubbleContainer && !$(bubbleContainer).is(\":visible\")) {\n                        triggerTalkAnimation();\n                        $(bubbleContainer).show();\n                    }\n                });\n            }\n        };\n        const triggerTalkAnimation = function () {\n            if (miauContainer) {\n                $(miauContainer).removeClass('miau-talk');\n                $(miauContainer).addClass('miau-talk');\n                setTimeout(function () {\n                    $(miauContainer).removeClass('miau-talk');\n                }, 8000);\n            }\n        };\n        return {\n            init: init\n        };\n    });"],"names":["define","$","Ajax","Str","userTourEventsModule","Templates","speechBubble","miauContainer","bubbleContainer","miauWrapper","storedActionDetails","callAction","event","classList","target","auditActionClass","Array","from","find","className","startsWith","idParts","split","length","sectionId","ruleKey","mapKey","actionDetails","Object","values","details","mapkey","args","params","forEach","param","key","value","response","call","methodname","endpoint","console","log","error","listenForTourEnd","tourId","userTourEvents","eventTypes","document","addEventListener","tourEnded","startTourSummary","listenForTourStart","tourStarted","listenForStepChange","stepRendered","stepHide","tourid","then","async","status","data","summaryContainer","processedResultsPromises","map","result","ruleNameKey","rulekey","ruleNameDisplay","parsedMessages","get_string","e","JSON","parse","messages","isArray","warn","String","messagePromises","langKeyMatch","msg","match","langKey","str","Promise","all","isTodo","isDone","processedResults","templateContext","results","hasResults","render","html","js","empty","appendNodeContents","is","triggerTalkAnimation","show","catch","errors","hideBubble","removeClass","hide","addMiauSprite","setTimeout","css","add","click","addClass","init","courseId","getElementById","on","preventDefault","stopPropagation","$button","this","originalText","text","prop","loadingText","courseid","tourData","tourdata","tourDetails","errorMessage","message","Error","actionDetailsMap","require","usertours","filterNames"],"mappings":"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"}